<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –†–∞–¥–∏–æ</title>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .map-container {
            height: 100vh;
            width: 100vw;
        }

        /* User Marker Pulse */
        .user-pulse {
            width: 20px;
            height: 20px;
            background: #2AABEE;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .user-pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(42, 171, 238, 0.4);
            border-radius: 50%;
            animation: pulse-blue 2s infinite;
            z-index: -1;
        }

        @keyframes pulse-blue {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        /* Marker Styles */
        .poi-marker {
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid white;
        }

        .poi-marker.visited {
            opacity: 0.6;
            filter: grayscale(100%);
        }

        .poi-marker.active {
            transform: scale(1.2);
            border-color: #3B82F6;
            z-index: 1000 !important;
        }
    </style>
</head>

<body class="bg-gray-100 overflow-hidden select-none">

    <!-- Map -->
    <div id="map" class="map-container absolute inset-0 z-0"></div>

    <!-- Controls -->
    <div class="absolute top-4 right-4 z-[400] flex flex-col gap-3 safe-area-top">
        <button onclick="centerMap()"
            class="bg-white/90 backdrop-blur p-3 rounded-full shadow-lg active:scale-95 transition text-blue-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
        <button id="debugBtn" onclick="toggleDebug()"
            class="bg-white/90 backdrop-blur p-3 rounded-full shadow-lg active:scale-95 transition text-gray-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>

    <!-- Bottom Sheet -->
    <div id="infoPanel"
        class="absolute bottom-6 left-4 right-4 z-[500] bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-5 transition-all duration-300 transform translate-y-[120%]">

        <div class="flex items-center gap-4">
            <div id="poiIconBox"
                class="w-12 h-12 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center text-2xl shadow-sm shrink-0">
                üìç
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex justify-between items-baseline">
                    <div class="text-xs text-blue-500 font-bold uppercase tracking-wide mb-1">–°–ª–µ–¥—É—é—â–∞—è —Ç–æ—á–∫–∞</div>
                    <div id="distBadge" class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500 font-mono">-- –º
                    </div>
                </div>
                <h2 id="poiName" class="text-lg font-bold text-gray-900 leading-tight truncate">...</h2>
            </div>
        </div>

        <div id="playerControls" class="mt-4 hidden animate-fade-in">
            <div class="h-1 bg-gray-200 rounded-full overflow-hidden mb-2">
                <div class="h-full bg-blue-500 w-0 transition-all duration-300 animate-pulse"></div>
            </div>
            <p id="playerStatus" class="text-xs text-center text-gray-400">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏...</p>
        </div>

        <!-- Debug Send Button (Only visible in debug) -->
        <button id="sendLocationBtn" onclick="sendLocationToBot()"
            class="mt-4 w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow active:scale-95 transition hidden">
            üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Config & State
        let map, userMarker, routeLine;
        let pois = [];
        let visitedOps = new Set();
        let currentTarget = null;
        let debugMode = false;
        let apiUrl = null;
        let isAudioPlaying = false;
        let lastSpokenId = null;

        // Init Parsing
        const urlParams = new URLSearchParams(window.location.search);
        apiUrl = urlParams.get('apiUrl');
        const startLat = parseFloat(urlParams.get('lat')) || 59.9343;
        const startLon = parseFloat(urlParams.get('lon')) || 30.3351;

        try {
            const poisData = JSON.parse(urlParams.get('pois') || '[]');
            pois = poisData.map((p, i) => ({ ...p, id: i })); // assign simple IDs
        } catch (e) { console.error("Error parsing POIs", e); }

        // --- Map Setup ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([startLat, startLon], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                opacity: 0.8
            }).addTo(map);

            // Create User Marker
            const userIcon = L.divIcon({
                className: 'user-pulse',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            userMarker = L.marker([startLat, startLon], { icon: userIcon }).addTo(map);

            // Add POIs
            pois.forEach(poi => {
                const icon = getEmojiForType(poi.tags);
                const poiIcon = L.divIcon({
                    html: icon,
                    className: 'poi-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([poi.lat, poi.lon], { icon: poiIcon }).addTo(map);
                marker.poiData = poi;
                marker.getElement().id = `marker-${poi.id}`;
            });

            // Initial focus
            updateNextTarget([startLat, startLon]);
            centerMap();

            // Debug click listener
            map.on('click', (e) => {
                if (debugMode) {
                    const { lat, lng } = e.latlng;
                    simulateMovement(lat, lng);
                }
            });
        }

        // --- Logic ---

        function simulateMovement(lat, lon) {
            userMarker.setLatLng([lat, lon]);
            updateNextTarget([lat, lon]);
            updateRoute([lat, lon], [currentTarget.lat, currentTarget.lon]);
            checkProximity(lat, lon);
        }

        function updateNextTarget(userLoc) {
            // Find nearest unvisited POI
            let minDist = Infinity;
            let nearest = null;

            pois.forEach(poi => {
                if (!visitedOps.has(poi.id)) {
                    const d = getDistance(userLoc[0], userLoc[1], poi.lat, poi.lon);
                    if (d < minDist) {
                        minDist = d;
                        nearest = poi;
                    }
                }
            });

            if (nearest && nearest !== currentTarget) {
                // Focus change
                if (currentTarget) {
                    const prevEl = document.getElementById(`marker-${currentTarget.id}`);
                    if (prevEl) prevEl.classList.remove('active');
                }

                currentTarget = nearest;
                const newEl = document.getElementById(`marker-${nearest.id}`);
                if (newEl) newEl.classList.add('active');

                // Update UI
                document.getElementById('infoPanel').classList.remove('translate-y-[120%]');
                document.getElementById('poiName').innerText = nearest.name;
                document.getElementById('poiIconBox').innerText = getEmojiForType(nearest.tags);
                document.getElementById('distBadge').innerText = Math.round(minDist) + ' –º';
            }

            if (nearest) {
                const d = getDistance(userLoc[0], userLoc[1], nearest.lat, nearest.lon);
                document.getElementById('distBadge').innerText = Math.round(d) + ' –º';
            }
        }

        async function updateRoute(start, end) {
            // Fetch OSRM via Proxy
            let url;
            if (apiUrl) {
                // Use our proxy to avoid CORS/HTTPS issues
                url = `${apiUrl}/api/route?start=${start[0]},${start[1]}&end=${end[0]},${end[1]}`;
            } else {
                // Direct fallback (might fail due to CORS/HTTPS)
                url = `https://router.project-osrm.org/route/v1/walking/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
            }

            try {
                const res = await fetch(url);
                const json = await res.json();

                if (json.routes && json.routes.length > 0) {
                    const route = json.routes[0];
                    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); // flip to lat,lon

                    if (routeLine) map.removeLayer(routeLine);

                    routeLine = L.polyline(coords, {
                        color: '#3B82F6',
                        weight: 6,
                        opacity: 0.8,
                        lineCap: 'round',
                        dashArray: '1, 10' // Dot line style for walking
                    }).addTo(map);
                }
            } catch (e) {
                console.error("Routing failed, fallback to straight line");
                if (routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline([start, end], { color: '#3B82F6', dashArray: '5,10' }).addTo(map);
            }
        }

        function checkProximity(lat, lon) {
            if (!currentTarget) return;
            const d = getDistance(lat, lon, currentTarget.lat, currentTarget.lon);

            if (d < 50) { // Arrival
                if (lastSpokenId !== currentTarget.id) {
                    lastSpokenId = currentTarget.id;
                    playStory(currentTarget);
                    visitedOps.add(currentTarget.id);
                    document.getElementById(`marker-${currentTarget.id}`).classList.add('visited');
                }
            }
        }

        // --- Audio & API ---
        async function playStory(poi) {
            const controls = document.getElementById('playerControls');
            const status = document.getElementById('playerStatus');
            controls.classList.remove('hidden');
            status.innerText = "–ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é...";

            if (apiUrl) {
                try {
                    const res = await fetch(`${apiUrl}/api/story`, {
                        method: 'POST',
                        body: JSON.stringify({
                            name: poi.name, tags: JSON.stringify(poi.tags),
                            lat: poi.lat, lon: poi.lon
                        }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await res.json();

                    if (data.audio_url) {
                        const audio = new Audio(`${apiUrl}${data.audio_url}`);
                        audio.play();
                        status.innerText = "–ò–¥–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...";
                        status.classList.add('text-blue-500');

                        audio.onended = () => {
                            controls.classList.add('hidden');
                            // Find next target
                            updateNextTarget([poi.lat, poi.lon]);
                        };
                    } else {
                        // Text fallback
                        speak(data.text);
                        controls.classList.add('hidden');
                    }
                } catch (e) {
                    console.error(e);
                    speak("–í—ã –ø—Ä–∏–±—ã–ª–∏ –∫ —Ç–æ—á–∫–µ " + poi.name);
                }
            } else {
                speak("–í—ã –ø—Ä–∏–±—ã–ª–∏ –∫ —Ç–æ—á–∫–µ " + poi.name);
            }
        }

        function speak(text) {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ru-RU';
                window.speechSynthesis.speak(u);
            }
        }

        // --- Utils ---
        function centerMap() {
            if (userMarker) map.setView(userMarker.getLatLng(), 17);
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const btn = document.getElementById('debugBtn');
            const sendBtn = document.getElementById('sendLocationBtn');

            if (debugMode) {
                btn.classList.replace('text-gray-400', 'text-amber-500');
                sendBtn.classList.remove('hidden');
                speak(''); // Unlock audio context
            } else {
                btn.classList.replace('text-amber-500', 'text-gray-400');
                sendBtn.classList.add('hidden');
            }
        }

        function sendLocationToBot() {
            if (userMarker) {
                const ll = userMarker.getLatLng();
                const data = JSON.stringify({
                    latitude: ll.lat,
                    longitude: ll.lng
                });
                tg.sendData(data);
                // Also can close via tg.close(), but we want to keep it open
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function getEmojiForType(tags) {
            if (tags.tourism === 'artwork') return 'üé®';
            if (tags.historic === 'memorial') return 'ü™¶';
            if (tags.historic === 'monument') return 'üóø';
            if (tags.tourism === 'museum') return 'üèõ';
            if (tags.amenity === 'place_of_worship') return '‚õ™';
            if (tags.leisure === 'park') return 'üå≥';
            return 'üìç';
        }

        // Handle Telegram Location if sent live
        // (For now simulation or init)

        window.onload = initMap;

    </script>
</body>

</html>